var rx=require("rx-lite");var _=require("lodash");var chalk=require("chalk");var ansiRegex=require("ansi-regex");var readline=require("readline");var cliWidth=require("cli-width");var runAsync=require("run-async");var Choices=require("../objects/choices");var ScreenManager=require("../utils/screen-manager");var Prompt=module.exports=function(question,rl,answers){_.assign(this,{answers:answers,status:"pending"});this.opt=_.defaults(_.clone(question),{validate:function(){return true},filter:function(val){return val},when:function(){return true}});if(!this.opt.message){this.throwParamError("message")}if(!this.opt.name){this.throwParamError("name")}if(Array.isArray(this.opt.choices)){this.opt.choices=new Choices(this.opt.choices,answers)}this.rl=rl;this.screen=new ScreenManager(this.rl)};Prompt.prototype.run=function(cb){this._run(function(value){this.filter(value,cb)}.bind(this))};Prompt.prototype._run=function(cb){cb()};Prompt.prototype.throwParamError=function(name){throw new Error("You must provide a `"+name+"` parameter")};Prompt.prototype.validate=function(input,cb){runAsync(this.opt.validate,cb,input)};Prompt.prototype.handleSubmitEvents=function(submit){var self=this;var validation=submit.flatMap(function(value){return rx.Observable.create(function(observer){runAsync(self.opt.validate,function(isValid){observer.onNext({isValid:isValid,value:self.getCurrentValue(value)});observer.onCompleted()},self.getCurrentValue(value),self.answers)})}).share();var success=validation.filter(function(state){return state.isValid===true}).take(1);var error=validation.filter(function(state){return state.isValid!==true}).takeUntil(success);return{success:success,error:error}};Prompt.prototype.getCurrentValue=function(value){return value};Prompt.prototype.filter=function(input,cb){runAsync(this.opt.filter,cb,input)};Prompt.prototype.prefix=function(str){str||(str="");return chalk.green("?")+" "+str};var reStrEnd=new RegExp("(?:"+ansiRegex().source+")$|$");Prompt.prototype.suffix=function(str){str||(str="");if(str.length<1||/[a-z1-9]$/i.test(chalk.stripColor(str))){str=str.replace(reStrEnd,":$&")}return str.trim()+" "};Prompt.prototype.getQuestion=function(){var message=chalk.green("?")+" "+chalk.bold(this.opt.message)+" ";if(this.opt.default!=null&&this.status!=="answered"){message+=chalk.dim("("+this.opt.default+") ")}return message};