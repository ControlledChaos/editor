var binary=require("../");var test=require("tap").test;var EventEmitter=require("events").EventEmitter;test("loop scan",function(t){t.plan(8+6+2);var em=new EventEmitter;binary.stream(em).loop(function(end){var vars_=this.vars;this.scan("filler","BEGINMSG").buffer("cmd",3).word8("num").tap(function(vars){t.strictEqual(vars,vars_);if(vars.num!=2&&vars.num!=6){t.same(vars.filler.length,0)}if(vars.cmd.toString()=="end")end()})}).tap(function(vars){t.same(vars.cmd.toString(),"end");t.same(vars.num,8)});setTimeout(function(){em.emit("data",new Buffer("BEGINMSGcmd"+"GARBAGEDATAXXXX"+"BEGINMSGcmd"+"BEGINMSGcmd"))},10);setTimeout(function(){em.emit("data",new Buffer("BEGINMSGcmd"+"BEGINMSGcmd"+"GARBAGEDATAXXXX"+"BEGINMSGcmd"));em.emit("data",new Buffer("BEGINMSGcmd"))},20);setTimeout(function(){em.emit("data",new Buffer("BEGINMSGend\b"))},30)});