var test=require("tap").test;var sys=require("sys");var BerWriter;var BerReader;test("load library",function(t){BerWriter=require("../../lib/index").BerWriter;t.ok(BerWriter);t.ok(new BerWriter);t.end()});test("write byte",function(t){var writer=new BerWriter;writer.writeByte(194);var ber=writer.buffer;t.ok(ber);t.equal(ber.length,1,"Wrong length");t.equal(ber[0],194,"value wrong");t.end()});test("write 1 byte int",function(t){var writer=new BerWriter;writer.writeInt(127);var ber=writer.buffer;t.ok(ber);t.equal(ber.length,3,"Wrong length for an int: "+ber.length);t.equal(ber[0],2,"ASN.1 tag wrong (2) -> "+ber[0]);t.equal(ber[1],1,"length wrong(1) -> "+ber[1]);t.equal(ber[2],127,"value wrong(3) -> "+ber[2]);t.end()});test("write 2 byte int",function(t){var writer=new BerWriter;writer.writeInt(32766);var ber=writer.buffer;t.ok(ber);t.equal(ber.length,4,"Wrong length for an int");t.equal(ber[0],2,"ASN.1 tag wrong");t.equal(ber[1],2,"length wrong");t.equal(ber[2],127,"value wrong (byte 1)");t.equal(ber[3],254,"value wrong (byte 2)");t.end()});test("write 3 byte int",function(t){var writer=new BerWriter;writer.writeInt(8388606);var ber=writer.buffer;t.ok(ber);t.equal(ber.length,5,"Wrong length for an int");t.equal(ber[0],2,"ASN.1 tag wrong");t.equal(ber[1],3,"length wrong");t.equal(ber[2],127,"value wrong (byte 1)");t.equal(ber[3],255,"value wrong (byte 2)");t.equal(ber[4],254,"value wrong (byte 3)");t.end()});test("write 4 byte int",function(t){var writer=new BerWriter;writer.writeInt(2147483646);var ber=writer.buffer;t.ok(ber);t.equal(ber.length,6,"Wrong length for an int");t.equal(ber[0],2,"ASN.1 tag wrong");t.equal(ber[1],4,"length wrong");t.equal(ber[2],127,"value wrong (byte 1)");t.equal(ber[3],255,"value wrong (byte 2)");t.equal(ber[4],255,"value wrong (byte 3)");t.equal(ber[5],254,"value wrong (byte 4)");t.end()});test("write 1 byte negative int",function(t){var writer=new BerWriter;writer.writeInt(-128);var ber=writer.buffer;t.ok(ber);t.equal(ber.length,3,"Wrong length for an int");t.equal(ber[0],2,"ASN.1 tag wrong");t.equal(ber[1],1,"length wrong");t.equal(ber[2],128,"value wrong (byte 1)");t.end()});test("write 2 byte negative int",function(t){var writer=new BerWriter;writer.writeInt(-22400);var ber=writer.buffer;t.ok(ber);t.equal(ber.length,4,"Wrong length for an int");t.equal(ber[0],2,"ASN.1 tag wrong");t.equal(ber[1],2,"length wrong");t.equal(ber[2],168,"value wrong (byte 1)");t.equal(ber[3],128,"value wrong (byte 2)");t.end()});test("write 3 byte negative int",function(t){var writer=new BerWriter;writer.writeInt(-481653);var ber=writer.buffer;t.ok(ber);t.equal(ber.length,5,"Wrong length for an int");t.equal(ber[0],2,"ASN.1 tag wrong");t.equal(ber[1],3,"length wrong");t.equal(ber[2],248,"value wrong (byte 1)");t.equal(ber[3],166,"value wrong (byte 2)");t.equal(ber[4],139,"value wrong (byte 3)");t.end()});test("write 4 byte negative int",function(t){var writer=new BerWriter;writer.writeInt(-1522904131);var ber=writer.buffer;t.ok(ber);t.equal(ber.length,6,"Wrong length for an int");t.equal(ber[0],2,"ASN.1 tag wrong");t.equal(ber[1],4,"length wrong");t.equal(ber[2],165,"value wrong (byte 1)");t.equal(ber[3],58,"value wrong (byte 2)");t.equal(ber[4],83,"value wrong (byte 3)");t.equal(ber[5],189,"value wrong (byte 4)");t.end()});test("write boolean",function(t){var writer=new BerWriter;writer.writeBoolean(true);writer.writeBoolean(false);var ber=writer.buffer;t.ok(ber);t.equal(ber.length,6,"Wrong length");t.equal(ber[0],1,"tag wrong");t.equal(ber[1],1,"length wrong");t.equal(ber[2],255,"value wrong");t.equal(ber[3],1,"tag wrong");t.equal(ber[4],1,"length wrong");t.equal(ber[5],0,"value wrong");t.end()});test("write string",function(t){var writer=new BerWriter;writer.writeString("hello world");var ber=writer.buffer;t.ok(ber);t.equal(ber.length,13,"wrong length");t.equal(ber[0],4,"wrong tag");t.equal(ber[1],11,"wrong length");t.equal(ber.slice(2).toString("utf8"),"hello world","wrong value");t.end()});test("write buffer",function(t){var writer=new BerWriter;writer.writeString("hello world");var ber=writer.buffer;var buf=new Buffer([4,11,48,9,2,1,15,1,1,255,1,1,255]);writer.writeBuffer(buf.slice(2,buf.length),4);ber=writer.buffer;t.ok(ber);t.equal(ber.length,26,"wrong length");t.equal(ber[0],4,"wrong tag");t.equal(ber[1],11,"wrong length");t.equal(ber.slice(2,13).toString("utf8"),"hello world","wrong value");t.equal(ber[13],buf[0],"wrong tag");t.equal(ber[14],buf[1],"wrong length");for(var i=13,j=0;i<ber.length&&j<buf.length;i++,j++){t.equal(ber[i],buf[j],"buffer contents not identical")}t.end()});test("write string array",function(t){var writer=new BerWriter;writer.writeStringArray(["hello world","fubar!"]);var ber=writer.buffer;t.ok(ber);t.equal(ber.length,21,"wrong length");t.equal(ber[0],4,"wrong tag");t.equal(ber[1],11,"wrong length");t.equal(ber.slice(2,13).toString("utf8"),"hello world","wrong value");t.equal(ber[13],4,"wrong tag");t.equal(ber[14],6,"wrong length");t.equal(ber.slice(15).toString("utf8"),"fubar!","wrong value");t.end()});test("resize internal buffer",function(t){var writer=new BerWriter({size:2});writer.writeString("hello world");var ber=writer.buffer;t.ok(ber);t.equal(ber.length,13,"wrong length");t.equal(ber[0],4,"wrong tag");t.equal(ber[1],11,"wrong length");t.equal(ber.slice(2).toString("utf8"),"hello world","wrong value");t.end()});test("sequence",function(t){var writer=new BerWriter({size:25});writer.startSequence();writer.writeString("hello world");writer.endSequence();var ber=writer.buffer;t.ok(ber);console.log(ber);t.equal(ber.length,15,"wrong length");t.equal(ber[0],48,"wrong tag");t.equal(ber[1],13,"wrong length");t.equal(ber[2],4,"wrong tag");t.equal(ber[3],11,"wrong length");t.equal(ber.slice(4).toString("utf8"),"hello world","wrong value");t.end()});test("nested sequence",function(t){var writer=new BerWriter({size:25});writer.startSequence();writer.writeString("hello world");writer.startSequence();writer.writeString("hello world");writer.endSequence();writer.endSequence();var ber=writer.buffer;t.ok(ber);t.equal(ber.length,30,"wrong length");t.equal(ber[0],48,"wrong tag");t.equal(ber[1],28,"wrong length");t.equal(ber[2],4,"wrong tag");t.equal(ber[3],11,"wrong length");t.equal(ber.slice(4,15).toString("utf8"),"hello world","wrong value");t.equal(ber[15],48,"wrong tag");t.equal(ber[16],13,"wrong length");t.equal(ber[17],4,"wrong tag");t.equal(ber[18],11,"wrong length");t.equal(ber.slice(19,30).toString("utf8"),"hello world","wrong value");t.end()});test("LDAP bind message",function(t){var dn="cn=foo,ou=unit,o=test";var writer=new BerWriter;writer.startSequence();writer.writeInt(3);writer.startSequence(96);writer.writeInt(3);writer.writeString(dn);writer.writeByte(128);writer.writeByte(0);writer.endSequence();writer.endSequence();var ber=writer.buffer;t.ok(ber);t.equal(ber.length,35,"wrong length (buffer)");t.equal(ber[0],48,"wrong tag");t.equal(ber[1],33,"wrong length");t.equal(ber[2],2,"wrong tag");t.equal(ber[3],1,"wrong length");t.equal(ber[4],3,"wrong value");t.equal(ber[5],96,"wrong tag");t.equal(ber[6],28,"wrong length");t.equal(ber[7],2,"wrong tag");t.equal(ber[8],1,"wrong length");t.equal(ber[9],3,"wrong value");t.equal(ber[10],4,"wrong tag");t.equal(ber[11],dn.length,"wrong length");t.equal(ber.slice(12,33).toString("utf8"),dn,"wrong value");t.equal(ber[33],128,"wrong tag");t.equal(ber[34],0,"wrong len");t.end()});test("Write OID",function(t){var oid="1.2.840.113549.1.1.1";var writer=new BerWriter;writer.writeOID(oid);var ber=writer.buffer;t.ok(ber);console.log(require("util").inspect(ber));console.log(require("util").inspect(new Buffer([6,9,42,134,72,134,247,13,1,1,1])));t.end()});