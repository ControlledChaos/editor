var test=require("tap").test;var BerReader;test("load library",function(t){BerReader=require("../../lib/index").BerReader;t.ok(BerReader);try{new BerReader;t.fail("Should have thrown")}catch(e){t.ok(e instanceof TypeError,"Should have been a type error")}t.end()});test("read byte",function(t){var reader=new BerReader(new Buffer([222]));t.ok(reader);t.equal(reader.readByte(),222,"wrong value");t.end()});test("read 1 byte int",function(t){var reader=new BerReader(new Buffer([2,1,3]));t.ok(reader);t.equal(reader.readInt(),3,"wrong value");t.equal(reader.length,1,"wrong length");t.end()});test("read 2 byte int",function(t){var reader=new BerReader(new Buffer([2,2,126,222]));t.ok(reader);t.equal(reader.readInt(),32478,"wrong value");t.equal(reader.length,2,"wrong length");t.end()});test("read 3 byte int",function(t){var reader=new BerReader(new Buffer([2,3,126,222,3]));t.ok(reader);t.equal(reader.readInt(),8314371,"wrong value");t.equal(reader.length,3,"wrong length");t.end()});test("read 4 byte int",function(t){var reader=new BerReader(new Buffer([2,4,126,222,3,1]));t.ok(reader);t.equal(reader.readInt(),2128478977,"wrong value");t.equal(reader.length,4,"wrong length");t.end()});test("read 1 byte negative int",function(t){var reader=new BerReader(new Buffer([2,1,220]));t.ok(reader);t.equal(reader.readInt(),-36,"wrong value");t.equal(reader.length,1,"wrong length");t.end()});test("read 2 byte negative int",function(t){var reader=new BerReader(new Buffer([2,2,192,78]));t.ok(reader);t.equal(reader.readInt(),-16306,"wrong value");t.equal(reader.length,2,"wrong length");t.end()});test("read 3 byte negative int",function(t){var reader=new BerReader(new Buffer([2,3,255,0,25]));t.ok(reader);t.equal(reader.readInt(),-65511,"wrong value");t.equal(reader.length,3,"wrong length");t.end()});test("read 4 byte negative int",function(t){var reader=new BerReader(new Buffer([2,4,145,124,34,31]));t.ok(reader);t.equal(reader.readInt(),-1854135777,"wrong value");t.equal(reader.length,4,"wrong length");t.end()});test("read boolean true",function(t){var reader=new BerReader(new Buffer([1,1,255]));t.ok(reader);t.equal(reader.readBoolean(),true,"wrong value");t.equal(reader.length,1,"wrong length");t.end()});test("read boolean false",function(t){var reader=new BerReader(new Buffer([1,1,0]));t.ok(reader);t.equal(reader.readBoolean(),false,"wrong value");t.equal(reader.length,1,"wrong length");t.end()});test("read enumeration",function(t){var reader=new BerReader(new Buffer([10,1,32]));t.ok(reader);t.equal(reader.readEnumeration(),32,"wrong value");t.equal(reader.length,1,"wrong length");t.end()});test("read string",function(t){var dn="cn=foo,ou=unit,o=test";var buf=new Buffer(dn.length+2);buf[0]=4;buf[1]=Buffer.byteLength(dn);buf.write(dn,2);var reader=new BerReader(buf);t.ok(reader);t.equal(reader.readString(),dn,"wrong value");t.equal(reader.length,dn.length,"wrong length");t.end()});test("read sequence",function(t){var reader=new BerReader(new Buffer([48,3,1,1,255]));t.ok(reader);t.equal(reader.readSequence(),48,"wrong value");t.equal(reader.length,3,"wrong length");t.equal(reader.readBoolean(),true,"wrong value");t.equal(reader.length,1,"wrong length");t.end()});test("anonymous LDAPv3 bind",function(t){var BIND=new Buffer(14);BIND[0]=48;BIND[1]=12;BIND[2]=2;BIND[3]=1;BIND[4]=4;BIND[5]=96;BIND[6]=7;BIND[7]=2;BIND[8]=1;BIND[9]=3;BIND[10]=4;BIND[11]=0;BIND[12]=128;BIND[13]=0;var ber=new BerReader(BIND);t.equal(ber.readSequence(),48,"Not an ASN.1 Sequence");t.equal(ber.length,12,"Message length should be 12");t.equal(ber.readInt(),4,"Message id should have been 4");t.equal(ber.readSequence(),96,"Bind Request should have been 96");t.equal(ber.length,7,"Bind length should have been 7");t.equal(ber.readInt(),3,"LDAP version should have been 3");t.equal(ber.readString(),"","Bind DN should have been empty");t.equal(ber.length,0,"string length should have been 0");t.equal(ber.readByte(),128,"Should have been ContextSpecific (choice)");t.equal(ber.readByte(),0,"Should have been simple bind");t.equal(null,ber.readByte(),"Should be out of data");t.end()});test("long string",function(t){var buf=new Buffer(256);var o;var s="2;649;CN=Red Hat CS 71GA Demo,O=Red Hat CS 71GA Demo,C=US;"+"CN=RHCS Agent - admin01,UID=admin01,O=redhat,C=US [1] This is "+"Teena Vradmin's description.";buf[0]=4;buf[1]=129;buf[2]=148;buf.write(s,3);var ber=new BerReader(buf.slice(0,3+s.length));t.equal(ber.readString(),s);t.end()});