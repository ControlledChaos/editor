(function( exports, $ ) {
    var api   = sedApp.editor;
    $( function() {

        //task 1 : current-menu-ancestor , current-menu-item
        //task 2 : close open submenu or megamenu when trigger is click and change navbar Align
        //task 3 : refresh woo basket after change or reset menu
        //task 4 : menu-- in Anchore scroll , have problem after scroll end
        //task 5 : improve sticky menu
        //task 6 : drag & drop modules or widget in megamenus && open magemenu after refresh with js cookie

        var _renderSedMegaMenu = function( id , newOptions ){

            if( !id )
                return ;

            var attrs = api.contentBuilder.getAttrs( id );

            if( !attrs )
                return ;

            var options = {
                trigger         : ( !_.isUndefined( attrs.trigger ) ) ?  attrs.trigger: "hover" ,
                isSticky        : ( !_.isUndefined( attrs.sticky ) && attrs.sticky ) ?  true: false,
                delay           : 500,
                orientation     : ( !_.isUndefined( attrs.orientation ) ) ?  attrs.orientation : "horizontal" ,
                scrollAnimate           : ( !_.isUndefined( attrs.scroll_animate_anchor ) ) ?  attrs.scroll_animate_anchor : 'easeInOutQuint' ,
                scrollAnimateDuration   : ( !_.isUndefined( attrs.scroll_animate_duration ) ) ?  attrs.scroll_animate_duration : 2000 ,
            };

            _.extend( options , newOptions );

            $('#' + id).sedmegamenu("destroy");

            $('#' + id).sedmegamenu( options );

        };

        api.Events.bind( "changePreviewMode" , function( mode ){

            if( mode == "on"){
                $('.module-megamenu').each(function(){
                    _renderSedMegaMenu( $(this).attr("id") , { } );
                });
            }else if(mode == "off"){

                $('.module-megamenu').each(function(){
                    $(this).removeClass("sticky-menu");
                    $(this).css({
                        position    : '' ,
                        top         : '' ,
                    });
                    $(this).parent().css({
                        position    : '' ,
                        height      : ''
                    });
                });

                $(window).unbind('scroll.sticky');
            }

        });

        api.shortcodeUpdate.sed_menu = {

            trigger : function( id , value ){
                _renderSedMegaMenu( id , { trigger : value } );
                $(window).unbind('scroll.sticky');
            },

            sticky : function( id , value ){
                $('#' + id).sedmegamenu("option" , "isSticky" , value );
                $(window).unbind('scroll.sticky');
            },

            delay_hover : function( id , value ){
                $('#' + id).sedmegamenu("option" , "delay" , value );
            },

            img_align : function( id , value ){

                var shortcode = api.contentBuilder.getShortcode( id ),
                    attrs = shortcode.attrs ,
                    image_icon_preference = attrs.image_icon_preference;

                $('#' + id).find(".item-img").each(function(){

                    var $parent = $(this).parent();

                    if( $.inArray( value , ["bottom" , "right"] ) != -1 )
                        $(this).appendTo( $parent );
                    else
                        $(this).prependTo( $parent );

                    if( $.inArray( value , ["bottom" , "top"] ) != -1 && ( image_icon_preference == "image" || $(this).siblings(".menu-item-icon").length == 0  ) )
                        $(this).parents("li:first").addClass("img-align");
                    else
                        $(this).parents("li:first").removeClass("img-align");

                });

                $('#' + id).data('sed.sedmegamenu').equalToHeight( );
                //_renderSedMegaMenu( id , { } );

            },

            icon_align : function( id , value ){

                var shortcode = api.contentBuilder.getShortcode( id ),
                    attrs = shortcode.attrs ,
                    image_icon_preference = attrs.image_icon_preference;

                $('#' + id).find(".menu-item-icon").each(function(){

                    var $parent = $(this).parent();

                    if( $.inArray( value , ["bottom" , "right"] ) != -1 )
                        $parent.append( $(this) );
                    else
                        $parent.prepend( $(this) );

                    if( $.inArray( value , ["bottom" , "top"] ) != -1  && ( image_icon_preference == "icon" || $(this).siblings(".item-img").length == 0  ) )
                        $(this).parents("li:first").addClass("icon-align");
                    else
                        $(this).parents("li:first").removeClass("icon-align");

                });

                $('#' + id).data('sed.sedmegamenu').equalToHeight( );

            },

            icon_font_size : function( id , value ){

                $('#' + id).find(".menu-item-icon").css({
                        "fontSize"        :  value + "px"
                });

                $('#' + id).data('sed.sedmegamenu').equalToHeight( );

            },

            /*orientation : function( id , value ){
                //reset megamenu
                _renderSedMegaMenu( id , { orientation : value } );

                var attrs = api.contentBuilder.getAttrs( id ) ,
                    $dropdowns = $('#' + id).find(".dropdown-menu[data-depth='0']");

                $(".sed-site-main-part").css("marginLeft" , "auto");

                if( value == "vertical"){
                    $('#' + id).addClass("vertical-megamenu");
                    //if( !_.isUndefined(attrs.skin) && attrs.skin == "default" )
                        //$(".sed-site-main-part").css("marginLeft" , (attrs.vertical_menu_width || 250 ) + "px" );

                    $dropdowns.each(function(){
                        if( !_.isUndefined( $(this).data("submenuWidth") ) ){
                            $(this).width( $(this).data("submenuWidth") );
                        }
                    });

                }else{
                    $('#' + id).removeClass("vertical-megamenu");

                    $dropdowns.each(function(){
                        if( !_.isUndefined( $(this).data("submenuWidth") ) ){
                            $(this).width( '' );
                        }
                    });

                }

            },*/

            display_description : function( id , value ){

                if( value )
                    $('#' + id).find("a[data-description]").removeClass("megamenu-display-description");
                else
                    $('#' + id).find("a[data-description]").addClass("megamenu-display-description");

            },

            image_width : function( id , value ){

                $('#' + id).find(".item-img span").css({
                    "width"        :  value + "px"
                });

                $('#' + id).find(".item-img span img").css({
                    "width"             :  value + "px" ,
                    "minWidth"          :  value + "px"
                });

                $('#' + id).data('sed.sedmegamenu').equalToHeight( );

            },

            image_height : function( id , value ){

                $('#' + id).find(".item-img span").css({
                    "height"        :  value + "px" ,
                    //"maxHeight"    :  value
                });

                $('#' + id).find(".item-img span img").css({
                    //"height"        :  value,
                    "minHeight"    :  value + "px"
                });

                $('#' + id).data('sed.sedmegamenu').equalToHeight( );

            },

            vertical_menu_width : function( id , value ){

                var menuData = $('#' + id).data('sed.sedmegamenu');

                if( menuData.options.orientation != "vertical" )
                    return ;

                $('#' + id).css({
                    "width"        :  value + "px"
                });

                var attrs = api.contentBuilder.getAttrs( id );
                if( !_.isUndefined(attrs.skin) && attrs.skin == "default" ){
                    $(".sed-site-main-part-vmenu-spacing").css({
                        "marginLeft"        :  value + "px"
                    });
                }

            },

            draggable_area_width : function( id , value ){

                $('#' + id).find(".menu-draggable-area").css({
                    "width"        :  value + "px"
                });

            },

            navbar_align : function( id , value ){

                $('#' + id).find(".sed-menu-container").css({
                    "textAlign"        :  value
                });

            } ,

            scroll_animate_anchor : function( id , value ){

                $('#' + id).sedmegamenu("option" , "scrollAnimate" , value );

            } ,

            scroll_animate_duration : function( id , value ){

                $('#' + id).sedmegamenu("option" , "scrollAnimateDuration" , value );

            } ,

            show_search : function( id , value ){

                if( value )
                    $('#' + id).find(".sed-menu-container > ul > li.sed-menu-item-search").removeClass("hide");
                else
                    $('#' + id).find(".sed-menu-container > ul > li.sed-menu-item-search").addClass("hide");

            } ,

            show_cart : function( id , value ){
                            
                if( value )
                    $('#' + id).find(".sed-menu-container > ul > li.sed-menu-item-cart").removeClass("hide");
                else
                    $('#' + id).find(".sed-menu-container > ul > li.sed-menu-item-cart").addClass("hide");

            } ,

            image_icon_preference : function( id , value ){

                $('#' + id).find("li.menu-item > a").each(function(){
                    if( value == "icon" ){
                        if( $(this).find(">.menu-item-icon").length > 0 ){
                            $(this).find(">.item-img").addClass("hide");
                            $(this).find(">.menu-item-icon").removeClass("hide");
                        }else{
                            $(this).find(">.item-img").removeClass("hide");
                        }
                    }else{
                        if( $(this).find(">.item-img").length > 0 ){
                            $(this).find(">.item-img").removeClass("hide");
                            $(this).find(">.menu-item-icon").addClass("hide");
                        }else{
                            $(this).find(">.menu-item-icon").removeClass("hide");
                        }
                    }
                });

            } ,

        };


        $(".megamenu-drag-area").livequery(function(e){
            $(this).bind( "afterActivateMegamenuDragArea" , function(e , menu , btn){
                if( !$(this).hasClass("active") ){
                    api.preview.send("megamenuDragAreaMode" , {
                        mode : "off" ,
                        id   : menu.attr("id") ,
                        item : btn.parents(".menu-item:first").attr("id")
                    });
                }else{
                    api.preview.send("megamenuDragAreaMode" , {
                        mode : "on" ,
                        id   : menu.attr("id") ,
                        item : btn.parents(".menu-item:first").attr("id")
                    });
                }
            });
        });

        api.preview.bind("megamenuDragAreaActiveAfterRefresh" , function( obj ){
            var dragAreaBtn = $("#" + obj.item).find(".megamenu-drag-area");
            var sedmegamenu = $('#' + obj.id).data('sed.sedmegamenu');

            sedmegamenu.openDropdown( $('#' + obj.item) );
            sedmegamenu.activeMegamenuDragArea( dragAreaBtn );
        });
                          
        $(".megamenu-module-widget-area").livequery(function(){
            var parentId    = $(this).data("parentId"),
                shortcode   = api.contentBuilder.getShortcode( parentId ) ,
                menuId      = $(this).data("menuId");

            if( _.isUndefined( shortcode ) ){
                var newShortcode = {
                    tag     : "sed_megamenu_drag_area" ,
                    id      : parentId ,
                    attrs   : {
                        parent_module   : "menu"
                    },
                    parent_id : menuId
                } ,
                postId = api.pageBuilder.getPostId( $("#" + menuId) );

                api.contentBuilder.addShortcodesToParent( menuId , [newShortcode] , postId );
            }

        });

        $(".module.module-megamenu .sed-title,.module.module-megamenu .sed-paragraph").livequery(function(){
            $(this).keydown(function(e){
                 if( event.which == 32 ){
                    e.stopPropagation();
                 }
            });
        });


    });
}(sedApp, jQuery));