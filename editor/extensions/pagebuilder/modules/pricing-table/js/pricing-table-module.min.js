(function( exports, $ ) {
    var api = sedApp.editor;

    $( function() {

        api.shortcodeUpdate.sed_pricing_table = {
            featured_column : function( id , value ){

                value = (!value) ? 0 : parseInt(value);
                var cols = $('[sed_model_id="' + id + '"]').find(".row:first > .column") , oldIdx , oldFeatured;

                cols.each(function(idx , element){
                    if( $(this).attr("class").indexOf( "featured" ) > -1 ){
                        oldIdx = idx;
                        oldFeatured = $(this);
                        return false;
                    }
                });

                if(value < 1){
                    //alert("number less than 1 not allow ");
                    return ;
                }

                if(value > cols.length ){
                    //alert("number more than columns number not allow ");
                    return ;
                }

                var currEl = cols.eq( value - 1 );
                if(!_.isUndefined( oldFeatured ))
                    oldFeatured.removeClass( "featured" );
                currEl.addClass( "featured" );

                //update shortcode model
                var postId = api.pageBuilder.getPostId( $('[sed_model_id="' + id + '"]') ) ,
                    shortcodes = api.contentBuilder.findAllTreeChildrenShortcode( id , postId) ;

                var colsModels = _.filter( shortcodes , function( shortcode ){
                    return shortcode.tag == "sed_pricing_table_column" && shortcode.parent_id == id;
                });

                if(!_.isUndefined( oldIdx ))
                    api.contentBuilder.updateShortcodeAttr("featured" , false , colsModels[oldIdx].id );

                api.contentBuilder.updateShortcodeAttr("featured" , true , colsModels[value - 1].id );

            } ,

            number_features : function( id , value ){

                var patternId = $('[sed_model_id="' + id + '"]').siblings(".add-item-features-pricing-table:first").attr("sed_model_id") ,
                    cols = $('[sed_model_id="' + id + '"]').find(".column"),
                    feaLen = $('[sed_model_id="' + id + '"]').find(".column:first .list-group-features:first").children("li").length;
                          
                 api.addModelPattern({
                    newValue        : value  ,
                    oldValue        : feaLen  ,
                    type            : "multiple"  ,
                    id              : id  ,
                    patternId       : patternId  ,
                    attrs           : [],
                    shortcode_name  : "sed_pricing_table_list_column"  ,
                    refresh         : false ,
                    group           : cols ,
                    list            : ".list-group-features:first" ,
                    memberG         : ">li" ,
                    //max             :   ,
                    min             : 1  ,
                    onAfterCreate   : function(){
                        api.Events.trigger( "syncModuleTmpl" , id , "sed_pricing_table" );
                    } ,
                 });

            },

            number_column : function( id , value ){
                var patternId = $('[sed_model_id="' + id + '"]').siblings(".add-column-pricing-table:first").attr("sed_model_id") ,
                    row = $('[sed_model_id="' + id + '"]').find(".row:first"),
                    cols = $('[sed_model_id="' + id + '"]').find(".row:first > .column") ,
                    colsLen = cols.length,
                    feaLen = $('[sed_model_id="' + id + '"]').find(".column:first .list-group-features:first").children("li").length;

                 api.addModelPattern({
                    newValue        : value  ,
                    oldValue        : colsLen  ,
                    type            : "single"  ,
                    id              : id  ,
                    patternId       : patternId  ,
                    list            : cols  ,
                    attrs           : [],
                    shortcode_name  : "sed_pricing_table"  ,
                    refresh         : false ,
                    //group           :   ,
                    max             : 12  ,
                    min             : 1  ,
                    onAfterRemove   : function(){
                        row.removeClass("columns-" + colsLen);
                        row.addClass("columns-" + value);
                    } ,
                    onAfterSingleCreate : function(){
                         if(feaLen > 0 && value > colsLen ){
                             var children = api.contentBuilder.getShortcodeChildren( id ) ,
                                 lastCId = children[children.length-1].id ,
                                 cChildren = api.contentBuilder.getShortcodeChildren( lastCId ) ,
                                 featuresList = _.find( cChildren , function(shortcode){
                                    return !_.isUndefined(shortcode.attrs) && !_.isUndefined(shortcode.attrs.list_group_features) && shortcode.attrs.list_group_features;
                                 }) ;

                             api.addModelPattern({
                                newValue        : feaLen  ,
                                oldValue        : 0  ,
                                type            : "single"  ,
                                id              : featuresList.id , //$("#" + id).find(".list-group-tr-rows:last").attr("id")  ,
                                patternId       : $('[sed_model_id="' + id + '"]').siblings(".add-item-features-pricing-table:first").attr("sed_model_id")  ,
                                //list            : $("#" + id).find(".list-group-hr-rows > th")  ,
                                attrs           : [],
                                shortcode_name  : "sed_pricing_table_list_column"  ,
                                refresh         : false ,
                                //group           :   ,
                              //max             :   ,  
                                min             : 1  ,
                                //onCreate        : function(){} ,
                                //onAddPatten     : function(){} ,
                             });
                         }
                    }
                    //onCreate        : function(){} ,
                    //onAddPatten     : function(){} ,
                 });

                 api.Events.trigger( "syncModuleTmpl" , id , "sed_pricing_table" );
            }

        };

    });


}(sedApp, jQuery));