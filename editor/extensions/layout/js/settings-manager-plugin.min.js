/**
 * @plugin.js
 * @App Settings Manager Plugin JS
 *
 * @License: http://www.siteeditor.org/license
 * @Contributing: http://www.siteeditor.org/contributing
 */

/*global siteEditor:true */
(function( exports, $ ){
    var api = sedApp.editor;

    api.AppSettings = api.Class.extend({

        initialize: function( options ){

            $.extend( this, options || {} );

            this.dialogSelector = "#sed-dialog-settings";

            this.settingsType = "app";

            this.templateType = "ajax";
            
            this.ready();
        },


        ready : function(){
            var self = this;

            //when render open settings dialog
            api.previewer.bind( 'openAppSettings' , function( data ) {
                self.openInitDialogSettings( data.settingId , data.forceOpen , data.reset );
            });

            this.view();

        },

        view : function(){
            var self = this;

            api.Events.bind( "beforerCreateSettingsControls" , function(id, data , extra){

                if( $( "#sed-app-control-" + id ).find(".sed_all_layouts_options_select").length > 0 ) {
                    var template = api.template("sed-layouts-select-options"),
                        content = template({layoutsSettings: api('sed_layouts_settings')()});

                    $(content).appendTo($("#sed-app-control-" + id).find(".sed_all_layouts_options_select"));
                }

            });

            api.addFilter( 'sedPreviewerTransportFilter' , function( transport , id ){
                var currGroupId = "sed_pages_layouts[" + api.currentLayoutGroup + "]";
                if( _.isEmpty( api("page_layout")() ) && id == currGroupId ){
                    transport = "refresh";
                }
                return transport;
            });


            api.addFilter( 'sedAjaxLoadOptionsDataFilter' , function( data ){
                if( data.setting_id == "sed_pages_layouts" ){
                    data.current_layout_group = api.currentLayoutGroup;
                    data.page_layout = api("page_layout")();
                }
                return data;
            });


            api.addFilter( 'sedAjaxLoadOptionsDataFilter' , function( data ){
                if( data.setting_id == "sed_content_options" ){
                    data.content_info = api.pageStaticContentInfo;
                }
                return data;
            });

            $( self.selector ).find(".sed-app-settings-normal").livequery(function(){
                $(this).fadeIn( "slow" );
            });

            $( self.selector ).find(".sed-tab-scope-options .tab-scope-item").livequery(function(){

                var __tabScope = function( element ){
                    var type = element.data("type");

                    element.siblings().removeClass("active");
                    element.addClass("active");

                    element.parents(".row_settings:first").siblings().hide();

                    var currScope = element.parents(".dialog-level-box-settings-container:first").find(".sed-option-scope." + type );

                    currScope.each(function(){
                        $(this).parents(".row_settings:first").fadeIn( "slow" );
                    });

                };

                if( $(this).hasClass("active") ){
                    __tabScope( $(this) );
                    $(this).parents(".dialog-level-box-settings-container:first").fadeIn( "slow" );
                }

                $(this).click(function(){
                    __tabScope( $(this) );
                });

            }, function() {
                // unbind the change event
                $(this).unbind('click');
            });

            $(".sed_ajax_load_options_btn").livequery(function(){
                $(this).click(function(){
                    var $this = $(this),
                        settingId = $(this).data("settingId");
                    self.openInitDialogSettings( settingId , true , true );
                });
            }, function() {
                // unbind the change event
                $(this).unbind('click');
            });

        },

        // , needToUpdateSettings
        openInitDialogSettings : function( settingId , forceOpen , reset ){

            api.previewer.send('current_element' , ''  );

            api.sedDialogSettings.openInitDialogSettings( settingId , forceOpen , reset , this.settingsType , this.templateType );

        },

    });


   $( function() {

        api.appSettings = new api.AppSettings({});

   });
})( sedApp, jQuery );