siteEditor.PluginManager.add("subThemes",function(a){var b=a.sedAppClass.editor,c=a.dom.Sizzle;b.mainThemeContentModel={},b.AppSubThemes=b.Class.extend({initialize:function(a){c.extend(this,a||{}),this.subThemesContent,this.mainThemeContentModel,this.currentMainContentModule={},this.copyPagesThemeContent,this.mainContentThemeId,this.mainContentModels,this.currentSubThemesContent={},this.sedThemeOptions={},this.currentSubTheme,this.currentPageId,this.ready()},getThemeIds:function(){},ready:function(){var a=this;b.previewer.bind("currentPageSubTheme",function(c){a.currentSubTheme=c.subTheme,a.currentPageId=c.page_id,b.settings.page.defaultSubTheme=c.subTheme;var d=b.control.instance("page_layout");d.update(c.subTheme)}),b.bind("save",function(){b.pagesThemeContent[b.settings.page.id]=a.copyPagesThemeContent,a.currentSubThemesContent={},b.previewer.send("sedSave")}),b.previewer.bind("currentMainContentModule",function(b){a.currentMainContentModule.module=b.module,a.currentMainContentModule.theme_id=b.themeId}),b.previewer.bind("page_mce_used_fonts",function(a){b("page_mce_used_fonts").set(a),console.log("fonts------",a)}),b.previewer.bind("sed_last_theme_id",function(a){b("sed_last_theme_id").set(a)}),b.previewer.bind("page_theme_rows_orders",function(a){b("page_theme_rows_orders").set(a)}),b.previewer.bind("sub_themes_models_update",function(d){b("sed_layouts_models").set(d);var e=_.values(d),f=[];_.each(e,function(a){f=c.merge(f,_.pluck(a,"theme_id"))}),_.uniq(f);var g=b("page_theme_rows_orders")();c.each(g,function(a,b){c.inArray(a,f)==-1&&delete g[a]}),b("page_theme_rows_orders").set(g),c.each(a.subThemesContent,function(b,d){c.inArray(b,f)==-1&&(delete a.subThemesContent[b],delete a.sedThemeOptions[b])});var h=_.pluck(a.mainThemeContentModel,"theme_id");_.uniq(h),c.each(h,function(b,d){c.inArray(d,f)==-1&&(a.mainThemeContentModel=_.filter(a.mainThemeContentModel,function(a){return a.theme_id!=d}))})}),b.Events.bind("beforeRefresh",function(){if(b("page_layout")()&&a.currentSubTheme!=b("page_layout")()){var d,e,f=b("sed_layouts_models")(),g=f[b("page_layout")()],h=f[a.currentSubTheme],i=_.pluck(g,"theme_id"),j="normal",k="normal",l=b("changed_sub_theme_override")();_.each(g,function(a){a.main_row&&(j="has_main_content",d=a.theme_id)});var m=function(b){h=_.map(h,function(d){if(d.theme_id==b){var e=c.inArray(a.currentPageId,d.exclude);e!=-1&&d.exclude.splice(e,1)}return d})},n=function(b){g=_.map(g,function(d){if(d.theme_id==b){var e=c.inArray(a.currentPageId,d.exclude);e==-1&&d.exclude.push(a.currentPageId)}return d})};if(_.each(b.pagesThemeContent[b.settings.page.id],function(a,b){_.isUndefined(a.attrs)||_.isUndefined(a.attrs.sed_main_content_row)?_.isUndefined(a.theme_id)||_.isUndefined(a.is_customize)||(m(a.theme_id),c.inArray(a.theme_id,i)==-1?(delete a.theme_id,delete a.is_customize):n(a.theme_id)):(e=a.id,_.isUndefined(a.theme_id)||_.isUndefined(a.is_customize)?!_.isUndefined(a.theme_id)&&_.isUndefined(a.is_customize)&&(k="has_main_content"):k="is_customize","normal"==k&&"has_main_content"==j?l||(a.is_customize=!0,a.theme_id=d,n(d)):"is_customize"==k&&"normal"==j?(m(a.theme_id),delete a.theme_id,delete a.is_customize):"is_customize"==k&&"has_main_content"==j&&c.inArray(a.theme_id,i)==-1&&(l||(m(a.theme_id),a.is_customize=!0,a.theme_id=d,n(d))))}),b("changed_sub_theme_mode").set(k),"is_customize"==k&&"has_main_content"==j&&c.inArray(e,i)==-1?l&&m(e):"is_customize"==k&&"has_main_content"==j&&c.inArray(e,i)!=-1&&(m(e),n(e)),("normal"==k&&"has_main_content"==j||"is_customize"==k&&"has_main_content"==j&&c.inArray(e,i)==-1)&&l){var o=a.findAllTreeChildrenShortcode(b.pagesThemeContent[b.settings.page.id],e),p=a.getShortcodeIndex(e,b.pagesThemeContent[b.settings.page.id]);a.deleteModule(e,o,b.pagesThemeContent[b.settings.page.id],p)}b("changed_sub_theme").set(!0)}else b("changed_sub_theme").set(!1);if(a.createThemeContent(),a.createThemeOptions(),b("page_layout")()&&a.currentSubTheme!=b("page_layout")()){var q=b.get();_.each(g,function(b){c.inArray(a.currentPageId,b.exclude)==-1&&(q=c.extend(!0,q,a.sedThemeOptions[b.theme_id]||{}))})}}),b.Events.bind("beforeSave",function(){b("changed_sub_theme").set(!1),a.createThemeContent(),a.createThemeOptions()});var d=!0;b.previewer.bind("previewerActive",function(){d===!0&&(a.subThemesContent=_.isEmpty(b("sed_layouts_content")())?{}:b("sed_layouts_content")(),a.mainThemeContentModel=b("sed_main_theme_content")(),a.sedThemeOptions=_.isEmpty(b("sed_theme_options")())?{}:b("sed_theme_options")(),d=!1)})},getOptions:function(a,d,e,f,g){var h=c.extend(!0,{},a),i={},j=_.chain(h).pluck("id").uniq().value();_.each(d,function(a){c.inArray(a,j)!=-1&&(_.isUndefined(i.sed_pb_modules)&&(i.sed_pb_modules={}),i.sed_pb_modules[a]=g[a])}),_.each(f,function(a){var b=e[a],c=_.keys(b);_.each(c,function(b){_.each(j,function(c){var d="#"+c;(d==b||b.indexOf(d+" ")>-1)&&(_.isUndefined(i[a])&&(i[a]={}),i[a][b]=e[a][b])})})}),h=_.chain(h).pluck("tag").uniq().value();var k=[];_.each(h,function(a){var d=_.pluck(b.modulesSettingsControls[a],"settings");d=_.chain(d).map(function(a){return a["default"]}).filter(function(a){return"general"==b.settings.settings[a].type}).uniq().value(),k=c.merge(k,d)}),c.each(_.uniq(k),function(a,b){i[b]=e[b]});var l={};return c.each(b("page_mce_used_fonts")(),function(a,b){c.inArray(a,j)!=-1&&(l[a]=b)}),i.page_mce_used_fonts=l,console.log("mceFonts------------",l),i},createThemeOptions:function(){var a=(new Date,this),d=b("sed_pb_modules")(),e=_.keys(d),f=b.get(),g=_.keys(b.settings.settings),h=_.chain(g).filter(function(a){return"style-editor"==b.settings.settings[a].type}).value();c.each(this.currentSubThemesContent,function(b,g){var i=a.getOptions(g,e,f,h,d),j=_.filter(a.mainThemeContentModel,function(a){return a.theme_id==b});j.length>0&&_.each(j,function(a){_.isUndefined(a.options)||(i=c.extend(!0,i,a.options))}),a.sedThemeOptions[b]=i}),b("sed_theme_options").set(a.sedThemeOptions)},createThemeContent:function(){var a=this,c=_.map(b.pagesThemeContent[b.settings.page.id],_.clone);_.each(c,function(d,e){if(!_.isUndefined(d.theme_id)&&_.isUndefined(d.is_customize)){if(!_.isUndefined(d.attrs)&&!_.isUndefined(d.attrs.sed_main_content_row)){var f,g;_.each(c,function(a,b){_.isUndefined(a.attrs)||_.isUndefined(a.attrs.sed_main_content)||!a.attrs.sed_main_content||(f=a,g=b)});var h=a.findAllTreeChildrenShortcode(b.pagesThemeContent[b.settings.page.id],f.id),i=_.map(h,_.clone);i.unshift(f),a.createMainThemeContentModel(i),a.mainContentThemeId=d.theme_id,a.mainContentModels=_.map(i,_.clone),a.deleteModule(f.id,h,b.pagesThemeContent[b.settings.page.id],!1)}var j=a.findAllTreeChildrenShortcode(b.pagesThemeContent[b.settings.page.id],d.id),k=_.map(j,_.clone);k.unshift(d),a.subThemesContent[d.theme_id]=k,a.currentSubThemesContent[d.theme_id]=k;var l=a.getShortcodeIndex(d.id,b.pagesThemeContent[b.settings.page.id]);a.deleteModule(d.id,j,b.pagesThemeContent[b.settings.page.id],l)}});var d=_.map(b.pagesThemeContent[b.settings.page.id],_.clone),e=[];_.each(d,function(c){if("root"==c.parent_id){var d=a.findAllTreeChildrenShortcode(b.pagesThemeContent[b.settings.page.id],c.id),f=_.map(d,_.clone);f.unshift(c),e.push(f)}}),b.pagesThemeContent[b.settings.page.id]=e,b("theme_content").set(b.pagesThemeContent[b.settings.page.id]),a.copyPagesThemeContent=c,b("sed_layouts_content").set(a.subThemesContent)},getShortcodeIndex:function(a,b){var d;return c.each(b,function(b,c){if(c.id==a)return d=b,!1}),d},deleteModule:function(a,b,c,d){for(var e=0;e<b.length;e++)for(var f=0;f<c.length;f++){var g=c[f];if(g.id==b[e].id){c.splice(f,1);break}}d!==!1&&c.splice(d,1)},findAllTreeChildrenShortcode:function(a,b){var d=this,e=[];return c.each(a,function(f,g){g.parent_id==b&&(e.push(g),e=c.merge(e,d.findAllTreeChildrenShortcode(a,g.id)))}),e},createMainThemeContentModel:function(a){var c=this,d=!1,e=b("sed_pb_modules")(),f=_.keys(e),g=b.get(),h=_.keys(b.settings.settings),i=_.chain(h).filter(function(a){return"style-editor"==b.settings.settings[a].type}).value(),j=c.getOptions(a,f,g,i,e);c.mainThemeContentModel.length>0&&(c.mainThemeContentModel=_.map(c.mainThemeContentModel,function(b){return b.module==c.currentMainContentModule.module&&b.theme_id==c.currentMainContentModule.theme_id?(b.content=a,b.options=j,d=!0,b):b})),d!==!1&&0!=c.mainThemeContentModel.length||c.mainThemeContentModel.push({content:a,module:this.currentMainContentModule.module,theme_id:this.currentMainContentModule.theme_id,options:j}),b("sed_main_theme_content").set(c.mainThemeContentModel)}}),b.GeneralSettingsScope=b.Class.extend({initialize:function(a){c.extend(this,a||{}),this.currentSubTheme,this.currentPageId,this.models={},this.initSettings=!0;var b=["padding_top","padding_bottom","padding_left","padding_right"],d=["background_color","background_image","parallax_background_image","parallax_background_ratio","background_attachment","background_image_scaling","background_position","background_gradient"];this.generalSettingsIds=c.merge(c.merge(b,d),["sheet_width","page_length"]),this.ready()},ready:function(){var a,d=this,e="#sed-general-settings-sub-themes .customize-settings-action",f="#sed-general-settings-sub-themes .sub-theme-item",g="#sed-general-settings-sub-themes li.item";b.previewer.bind("currentPageSubTheme",function(a){d.currentSubTheme=a.subTheme,d.currentPageId=a.page_id,d.initSettings=!1,d.models=_.isEmpty(b("sed_general_theme_options")())?{}:c.extend(!0,{},b("sed_general_theme_options")())}),b.Events.bind("beforeRefresh",function(){d.setSettingsValues()}),b.Events.bind("beforeSave",function(){d.setSettingsValues()}),b.bind("save",function(){!_.isUndefined(d.models.sheet_width)&&d.models.sheet_width.scope.sub_themes.length>0&&(c(e).show(),c.inArray(d.currentPageId,d.models.sheet_width.scope.exclude)==-1&&c(e).find(".sed-settings-theme-type").filter(function(){return"public"===this.value}).prop("checked",!0))}),c("#page_general_settings").click(function(){d.initSettings===!1&&(!_.isUndefined(d.models.sheet_width)&&d.models.sheet_width.scope.sub_themes.length>0?(c(e).show(),a=c.inArray(d.currentPageId,d.models.sheet_width.scope.exclude)==-1?"public":"private",c(e).find(".sed-settings-theme-type").filter(function(){return this.value===a}).prop("checked",!0),"private"==a?c(g).hide():c(g).show(),c(f).find('[name="sed-sub-theme"]').each(function(){c.inArray(c(this).val(),d.models.sheet_width.scope.sub_themes)!=-1?c(this).prop("checked",!0):c(this).prop("checked",!1)}),d.checkAll()):c(e).hide(),d.initSettings=!0)}),c(f).livequery(function(){c(this).find(".sed-sub-themes-check-box").click(function(a){var e=c(this).find('[name="sed-sub-theme"]').val();if(c(this).find('[name="sed-sub-theme"]').is(":checked")){if(_.each(d.generalSettingsIds,function(a){d.addOptionsToModel(a,b.settings.settings[a].type,e)}),d.currentSubTheme!=e&&c.inArray(d.currentSubTheme,d.models.sheet_width.scope.sub_themes)==-1){var f='[data-sub-theme-name="'+d.currentSubTheme+'"] input[name="sed-sub-theme"]';c(this).parent().siblings().find(f).prop("checked",!0),_.each(d.generalSettingsIds,function(a){d.addOptionsToModel(a,b.settings.settings[a].type,d.currentSubTheme)})}}else if(_.each(d.generalSettingsIds,function(a){d.removeOptionsFromModel(a,e)}),d.currentSubTheme==e){var g=_.map(d.models.sheet_width.scope.sub_themes,_.clone),h=c(this);_.each(g,function(a){var b='[data-sub-theme-name="'+a+'"] input[name="sed-sub-theme"]';h.parent().siblings().find(b).prop("checked",!1),_.each(d.generalSettingsIds,function(b){d.removeOptionsFromModel(b,a)})})}d.checkAll()})}),c(e).livequery(function(){c(this);c(this).find(".sed-settings-theme-type").click(function(a){var b=c(this).val();"public"==b?(c(g).show(),_.each(d.generalSettingsIds,function(a){d.updateExcludeSettings(a,"remove")})):(c(g).hide(),_.each(d.generalSettingsIds,function(a){d.updateExcludeSettings(a,"add")}))})}),c("#sed-general-settings-sub-themes .sed-all-sub-themes").find('[name="sed-sub-theme"]').click(function(a){var e=c(this).is(":checked");c(f).find('[name="sed-sub-theme"]').each(function(){var a=c(this).val();e?c(this).is(":checked")||(c(this).prop("checked",!0),_.each(d.generalSettingsIds,function(c){d.addOptionsToModel(c,b.settings.settings[c].type,a)})):c(this).is(":checked")&&(c(this).prop("checked",!1),_.each(d.generalSettingsIds,function(b){d.removeOptionsFromModel(b,a)}))})})},checkAll:function(){var a=this,b="#sed-general-settings-sub-themes .sub-theme-item";_.isUndefined(a.models.sheet_width)||a.models.sheet_width.scope.sub_themes.length!=c(b).find('[name="sed-sub-theme"]').length?c("#sed-general-settings-sub-themes .sed-all-sub-themes").find('[name="sed-sub-theme"]').prop("checked",!1):c("#sed-general-settings-sub-themes .sed-all-sub-themes").find('[name="sed-sub-theme"]').prop("checked",!0)},setSettingsValues:function(){var a=this;c.each(this.models,function(d,e){var f=c.inArray(a.currentPageId,a.models[d].scope.exclude);if(f>-1)return!1;var g;g="style-editor"==e.type?_.isUndefined(b(d)()["#page"])?b(d)()["default"]:_.isObject(b(d)()["#page"])?_.clone(b(d)()["#page"]):b(d)()["#page"]:b(d)(),a.models[d].value=g}),console.log("this.models----now---------",this.models),b("sed_general_theme_options").set(c.extend(!0,{},this.models))},updateExcludeSettings:function(a,b){if("add"==b){var d=c.inArray(this.currentPageId,this.models[a].scope.exclude);d==-1&&this.models[a].scope.exclude.push(this.currentPageId)}else if("remove"==b){var d=c.inArray(this.currentPageId,this.models[a].scope.exclude);alert(d),d!=-1&&this.models[a].scope.exclude.splice(d,1)}this.setSettingsValues()},addOptionsToModel:function(a,b,d){_.isUndefined(this.models[a])?this.models[a]={scope:{sub_themes:[d],exclude:[]},value:"",type:b}:c.inArray(a,this.models[a].scope.sub_themes)==-1&&this.models[a].scope.sub_themes.push(d),this.setSettingsValues()},removeOptionsFromModel:function(a,b){var d=c.inArray(b,this.models[a].scope.sub_themes),e="#sed-general-settings-sub-themes .customize-settings-action";d>-1&&this.models[a].scope.sub_themes.splice(d,1),0==this.models[a].scope.sub_themes.length&&(delete this.models[a],c(e).hide()),this.setSettingsValues()}}),c(function(){b.appSubThemes=new b.AppSubThemes({}),b.generalSettingsScope=new b.GeneralSettingsScope({})})});